{% extends 'base.html' %}

{% block title %}ğŸ“º Ø¯Ø±ÙˆØ³ Ø§Ù„Ù‚Ø³Ù…{% endblock %}

{% block head %}
<style>
  .video-fixed {
    width: 100%;
    max-height: 250px;
    border-radius: 12px;
    border: 3px solid #3B82F6;
  }
  .accordion-btn {
    background-color: #f1f5f9;
    transition: background 0.3s;
  }
  .accordion-btn:hover {
    background-color: #e2e8f0;
  }
  .progress-container {
    background: #e5e7eb;
    border-radius: 10px;
    height: 22px;
    margin-top: 12px;
    overflow: hidden;
  }
  .progress-bar {
    background: #3B82F6;
    height: 100%;
    width: 0%;
    color: red;
    font-weight: bold;
    font-size: 14px;
    text-align: center;
    line-height: 22px;
    transition: width 0.4s ease;
  }
  .external-link {
    display: inline-block;
    margin-top: 12px;
    padding: 8px 15px;
    background-color: #10b981;
    color: white;
    font-weight: bold;
    border-radius: 8px;
    text-decoration: none;
    transition: background 0.3s;
  }
  .external-link:hover {
    background-color: #059669;
  }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto mt-8 px-4">
  <h2 class="text-2xl font-bold text-center text-blue-700 mb-6">
    ğŸ“š Ø¯Ø±ÙˆØ³ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
  </h2>

  {% if lessons %}
    <div class="space-y-4">
      {% for lesson in lessons %}
        <div class="border border-blue-600 rounded-xl shadow">
          <!-- Ø²Ø± Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
          <button type="button"
                  class="accordion-btn w-full text-right px-5 py-4 text-blue-800 font-semibold text-lg flex justify-between items-center"
                  onclick="toggleAccordion('lesson{{ forloop.counter }}')">
            <span>ğŸ“˜ {{ lesson.title }}</span>
            <svg class="w-5 h-5 transition-transform transform"
                 id="icon-lesson{{ forloop.counter }}"
                 fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="2" d="M19 9l-7 7-7-7"/>
            </svg>
          </button>

          <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ -->
          <div id="lesson{{ forloop.counter }}" class="hidden px-6 pb-5 text-gray-700">
            <p class="mb-3">{{ lesson.description }}</p>

            {% if lesson.video_file %}
              <video class="video-fixed mx-auto"
                     controls
                     ontimeupdate="updateProgress({{ lesson.id }}, this)">
                <source src="{{ lesson.video_file.url }}" type="video/mp4">
                Ù…ØªØµÙØ­Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.
              </video>

              <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
              <div class="progress-container">
                <div id="progress-bar-{{ lesson.id }}" class="progress-bar">0%</div>
              </div>
            {% else %}
              <p class="text-red-500 font-bold text-center mt-3">
                ğŸš« Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙÙŠØ¯ÙŠÙˆ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¯Ø±Ø³.
              </p>
            {% endif %}

            {% if lesson.external_link %}
              <a href="{{ lesson.external_link }}" target="_blank" class="external-link">
                ğŸŒ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ
              </a>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center text-gray-600 mt-10">
      Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ù…ØªØ§Ø­Ø© Ù„Ù‚Ø³Ù…Ùƒ Ø­Ø§Ù„ÙŠÙ‹Ø§.
    </div>
  {% endif %}
</div>

<script>
  function toggleAccordion(id) {
    const content = document.getElementById(id);
    const icon = document.getElementById("icon-" + id);
    content.classList.toggle("hidden");
    icon.classList.toggle("rotate-180");
  }

  function updateProgress(lessonId, videoElement) {
    if (!videoElement.duration) return;

    const percentage = (videoElement.currentTime / videoElement.duration) * 100;

    const bar = document.getElementById(`progress-bar-${lessonId}`);
    if (bar) {
      bar.style.width = `${percentage}%`;
      bar.innerText = `${Math.round(percentage)}%`;
    }

    if (Math.floor(videoElement.currentTime) % 5 === 0) {
      fetch(`/videos/lessons/${lessonId}/update_progress/`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
          "Content-Type": "application/json",
        },
        body: JSON.stringify({ progress: percentage }),
      });
    }
  }
</script>
{% endblock %}
